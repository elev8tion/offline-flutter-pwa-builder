/**
 * Build Module Templates
 *
 * Handlebars templates for generating build and deployment configurations.
 */

import type { Template } from "../../core/types.js";

// ============================================================================
// BUILD TEMPLATES
// ============================================================================

export const BUILD_TEMPLATES: Template[] = [
  // ---------------------------------------------------------------------------
  // Vercel Configuration
  // ---------------------------------------------------------------------------
  {
    id: "vercel_config",
    name: "Vercel Configuration",
    description: "vercel.json configuration for Vercel deployment",
    type: "file",
    source: `{
  "version": 2,
  "name": "{{projectName}}",
  "builds": [
    {
      "src": "build/web/**",
      "use": "@vercel/static"
    }
  ],
  "routes": [
    {
      "src": "/(.*)",
      "dest": "/build/web/$1"
    }
  ],
  "headers": [
    {
      "source": "/(.*)",
      "headers": [
        { "key": "X-Content-Type-Options", "value": "nosniff" },
        { "key": "X-Frame-Options", "value": "SAMEORIGIN" },
        { "key": "X-XSS-Protection", "value": "1; mode=block" },
        { "key": "Referrer-Policy", "value": "strict-origin-when-cross-origin" }
      ]
    },
    {
      "source": "/flutter_service_worker.js",
      "headers": [
        { "key": "Cache-Control", "value": "no-cache" },
        { "key": "Service-Worker-Allowed", "value": "/" }
      ]
    },
    {
      "source": "/assets/(.*)",
      "headers": [
        { "key": "Cache-Control", "value": "public, max-age=31536000, immutable" }
      ]
    }
  ]
}
`,
    output: {
      path: "",
      filename: "vercel",
      extension: ".json",
    },
  },

  // ---------------------------------------------------------------------------
  // Netlify Configuration
  // ---------------------------------------------------------------------------
  {
    id: "netlify_config",
    name: "Netlify Configuration",
    description: "netlify.toml configuration for Netlify deployment",
    type: "file",
    source: `# Netlify Configuration
# Generated by Offline Flutter PWA Builder

[build]
  command = "{{buildCommand}}"
  publish = "{{publishDirectory}}"

[build.environment]
  FLUTTER_WEB = "true"

# Security Headers
[[headers]]
  for = "/*"
  [headers.values]
    X-Content-Type-Options = "nosniff"
    X-Frame-Options = "SAMEORIGIN"
    X-XSS-Protection = "1; mode=block"
    Referrer-Policy = "strict-origin-when-cross-origin"
    {{#if csp}}
    Content-Security-Policy = "{{csp}}"
    {{/if}}

# Service Worker Headers
[[headers]]
  for = "/flutter_service_worker.js"
  [headers.values]
    Cache-Control = "no-cache"
    Service-Worker-Allowed = "/"

# Cache static assets
[[headers]]
  for = "/assets/*"
  [headers.values]
    Cache-Control = "public, max-age=31536000, immutable"

# WASM MIME type
[[headers]]
  for = "/*.wasm"
  [headers.values]
    Content-Type = "application/wasm"
    Cache-Control = "public, max-age=31536000, immutable"

# SPA Fallback
[[redirects]]
  from = "/*"
  to = "/index.html"
  status = 200
`,
    output: {
      path: "",
      filename: "netlify",
      extension: ".toml",
    },
  },

  // ---------------------------------------------------------------------------
  // Firebase Configuration
  // ---------------------------------------------------------------------------
  {
    id: "firebase_config",
    name: "Firebase Configuration",
    description: "firebase.json configuration for Firebase Hosting",
    type: "file",
    source: `{
  "hosting": {
    "public": "{{publishDirectory}}",
    "ignore": [
      "firebase.json",
      "**/.*",
      "**/node_modules/**"
    ],
    "rewrites": [
      {
        "source": "**",
        "destination": "/index.html"
      }
    ],
    "headers": [
      {
        "source": "**",
        "headers": [
          { "key": "X-Content-Type-Options", "value": "nosniff" },
          { "key": "X-Frame-Options", "value": "SAMEORIGIN" },
          { "key": "X-XSS-Protection", "value": "1; mode=block" }
        ]
      },
      {
        "source": "/flutter_service_worker.js",
        "headers": [
          { "key": "Cache-Control", "value": "no-cache" },
          { "key": "Service-Worker-Allowed", "value": "/" }
        ]
      },
      {
        "source": "**/*.@(js|css)",
        "headers": [
          { "key": "Cache-Control", "value": "public, max-age=31536000, immutable" }
        ]
      },
      {
        "source": "**/*.wasm",
        "headers": [
          { "key": "Content-Type", "value": "application/wasm" },
          { "key": "Cache-Control", "value": "public, max-age=31536000, immutable" }
        ]
      }
    ]
  }
}
`,
    output: {
      path: "",
      filename: "firebase",
      extension: ".json",
    },
  },

  // ---------------------------------------------------------------------------
  // GitHub Actions Workflow
  // ---------------------------------------------------------------------------
  {
    id: "github_actions_workflow",
    name: "GitHub Actions Workflow",
    description: "CI/CD workflow for GitHub Actions",
    type: "file",
    source: `# GitHub Actions Workflow
# Generated by Offline Flutter PWA Builder

name: Build and Deploy

on:
  push:
    branches: [{{#each branches}}'{{this}}'{{#unless @last}}, {{/unless}}{{/each}}]
  pull_request:
    branches: [{{#each branches}}'{{this}}'{{#unless @last}}, {{/unless}}{{/each}}]

env:
  FLUTTER_VERSION: '{{flutterVersion}}'

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: \${{ env.FLUTTER_VERSION }}
          channel: 'stable'
          cache: true

      - name: Install dependencies
        run: flutter pub get

      {{#if includeLinting}}
      - name: Analyze code
        run: flutter analyze
      {{/if}}

      {{#if includeTests}}
      - name: Run tests
        run: flutter test
      {{/if}}

      - name: Build web
        run: flutter build web --release --tree-shake-icons

      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: web-build
          path: build/web
          retention-days: 7

  {{#if autoDeploy}}
  deploy:
    needs: build
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'

    steps:
      - name: Download build artifact
        uses: actions/download-artifact@v4
        with:
          name: web-build
          path: build/web

      {{#eq deployTarget 'vercel'}}
      - name: Deploy to Vercel
        uses: amondnet/vercel-action@v25
        with:
          vercel-token: \${{ secrets.VERCEL_TOKEN }}
          vercel-org-id: \${{ secrets.VERCEL_ORG_ID }}
          vercel-project-id: \${{ secrets.VERCEL_PROJECT_ID }}
          vercel-args: '--prod'
      {{/eq}}

      {{#eq deployTarget 'netlify'}}
      - name: Deploy to Netlify
        uses: nwtgck/actions-netlify@v2
        with:
          publish-dir: './build/web'
          production-deploy: true
        env:
          NETLIFY_AUTH_TOKEN: \${{ secrets.NETLIFY_AUTH_TOKEN }}
          NETLIFY_SITE_ID: \${{ secrets.NETLIFY_SITE_ID }}
      {{/eq}}

      {{#eq deployTarget 'firebase'}}
      - name: Deploy to Firebase
        uses: FirebaseExtended/action-hosting-deploy@v0
        with:
          repoToken: '\${{ secrets.GITHUB_TOKEN }}'
          firebaseServiceAccount: '\${{ secrets.FIREBASE_SERVICE_ACCOUNT }}'
          channelId: live
          projectId: {{firebaseProjectId}}
      {{/eq}}

      {{#eq deployTarget 'github-pages'}}
      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: \${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./build/web
      {{/eq}}
  {{/if}}
`,
    output: {
      path: ".github/workflows",
      filename: "build-deploy",
      extension: ".yml",
    },
  },

  // ---------------------------------------------------------------------------
  // GitLab CI Configuration
  // ---------------------------------------------------------------------------
  {
    id: "gitlab_ci_config",
    name: "GitLab CI Configuration",
    description: ".gitlab-ci.yml for GitLab CI/CD",
    type: "file",
    source: `# GitLab CI Configuration
# Generated by Offline Flutter PWA Builder

image: ghcr.io/cirruslabs/flutter:{{flutterVersion}}

stages:
  - install
  - analyze
  - test
  - build
  - deploy

variables:
  PUB_CACHE: $CI_PROJECT_DIR/.pub-cache

cache:
  key: \${CI_COMMIT_REF_SLUG}
  paths:
    - .pub-cache/

install:
  stage: install
  script:
    - flutter pub get

{{#if includeLinting}}
analyze:
  stage: analyze
  script:
    - flutter analyze
  needs: [install]
{{/if}}

{{#if includeTests}}
test:
  stage: test
  script:
    - flutter test
  needs: [install]
{{/if}}

build:
  stage: build
  script:
    - flutter build web --release --tree-shake-icons
  artifacts:
    paths:
      - build/web
    expire_in: 1 week
  needs: [{{#if includeLinting}}analyze{{/if}}{{#if includeTests}}, test{{/if}}]

{{#if autoDeploy}}
deploy:
  stage: deploy
  script:
    - echo "Deploying to {{deployTarget}}"
    # Add deployment commands here
  only:
    - main
  needs: [build]
  environment:
    name: production
    url: https://{{projectName}}.example.com
{{/if}}
`,
    output: {
      path: "",
      filename: ".gitlab-ci",
      extension: ".yml",
    },
  },

  // ---------------------------------------------------------------------------
  // Environment Configuration (Dart)
  // ---------------------------------------------------------------------------
  {
    id: "environment_dart",
    name: "Environment Configuration",
    description: "Dart environment configuration class",
    type: "file",
    source: `// Environment Configuration
// Generated by Offline Flutter PWA Builder

/// Application environment
enum Environment { development, staging, production }

/// Current build environment
const Environment currentEnvironment = Environment.{{mode}};

/// Environment configuration class
class EnvConfig {
  EnvConfig._();

  /// Application name
  static const String appName = String.fromEnvironment(
    'APP_NAME',
    defaultValue: '{{appName}}',
  );

  /// Application version
  static const String appVersion = String.fromEnvironment(
    'APP_VERSION',
    defaultValue: '{{appVersion}}',
  );

  /// Whether running in production mode
  static const bool isProduction = currentEnvironment == Environment.production;

  /// Whether running in development mode
  static const bool isDevelopment = currentEnvironment == Environment.development;

  /// Whether running in staging mode
  static const bool isStaging = currentEnvironment == Environment.staging;

  /// API base URL (environment-specific)
  static String get apiBaseUrl {
    switch (currentEnvironment) {
      case Environment.production:
        return const String.fromEnvironment(
          'API_URL_PROD',
          defaultValue: '{{apiUrlProd}}',
        );
      case Environment.staging:
        return const String.fromEnvironment(
          'API_URL_STAGING',
          defaultValue: '{{apiUrlStaging}}',
        );
      case Environment.development:
        return const String.fromEnvironment(
          'API_URL_DEV',
          defaultValue: '{{apiUrlDev}}',
        );
    }
  }

  /// Whether to enable debug logging
  static bool get enableLogging {
    return !isProduction || const bool.fromEnvironment('ENABLE_LOGGING');
  }

  /// Whether to enable analytics
  static bool get enableAnalytics {
    return isProduction && const bool.fromEnvironment('ENABLE_ANALYTICS', defaultValue: true);
  }

  {{#each customVariables}}
  /// {{description}}
  static const {{dartType}} {{name}} = {{dartType}}.fromEnvironment(
    '{{envName}}',
    {{#if defaultValue}}defaultValue: {{defaultValue}},{{/if}}
  );

  {{/each}}
}
`,
    output: {
      path: "lib/core/config",
      filename: "environment",
      extension: ".dart",
    },
  },

  // ---------------------------------------------------------------------------
  // Build Script
  // ---------------------------------------------------------------------------
  {
    id: "build_script",
    name: "Build Script",
    description: "Shell script for building the Flutter PWA",
    type: "file",
    source: `#!/bin/bash
# Build Script
# Generated by Offline Flutter PWA Builder

set -e

# Configuration
MODE="{{mode}}"
WEB_RENDERER="{{webRenderer}}"
TREE_SHAKE={{treeShake}}
SOURCE_MAPS={{sourceMaps}}

echo "=========================================="
echo "Building Flutter PWA"
echo "=========================================="
echo "Mode: $MODE"
echo "Web Renderer: $WEB_RENDERER"
echo "Tree Shake Icons: $TREE_SHAKE"
echo "Source Maps: $SOURCE_MAPS"
echo ""

# Clean previous build
echo "Cleaning previous build..."
flutter clean

# Get dependencies
echo "Installing dependencies..."
flutter pub get

# Run code generation if build.yaml exists
if [ -f "build.yaml" ]; then
  echo "Running code generation..."
  dart run build_runner build --delete-conflicting-outputs
fi

# Build for web
echo "Building web application..."
BUILD_ARGS="flutter build web"

if [ "$MODE" = "production" ]; then
  BUILD_ARGS="$BUILD_ARGS --release"
else
  BUILD_ARGS="$BUILD_ARGS --profile"
fi

if [ "$WEB_RENDERER" != "auto" ]; then
  BUILD_ARGS="$BUILD_ARGS --web-renderer=$WEB_RENDERER"
fi

if [ "$TREE_SHAKE" = "true" ]; then
  BUILD_ARGS="$BUILD_ARGS --tree-shake-icons"
fi

if [ "$SOURCE_MAPS" = "true" ]; then
  BUILD_ARGS="$BUILD_ARGS --source-maps"
fi

eval $BUILD_ARGS

echo ""
echo "=========================================="
echo "Build Complete!"
echo "=========================================="
echo "Output: build/web"
echo ""
echo "Build size:"
du -sh build/web
echo ""
echo "Files:"
ls -la build/web
`,
    output: {
      path: "scripts",
      filename: "build",
      extension: ".sh",
    },
  },

  // ---------------------------------------------------------------------------
  // Development Server Script
  // ---------------------------------------------------------------------------
  {
    id: "dev_server_script",
    name: "Development Server Script",
    description: "Shell script for running local development server",
    type: "file",
    source: `#!/bin/bash
# Development Server Script
# Generated by Offline Flutter PWA Builder

set -e

# Configuration
PORT={{port}}
HOST="{{host}}"
WEB_RENDERER="{{webRenderer}}"
DEBUG_MODE={{debugMode}}

echo "=========================================="
echo "Starting Development Server"
echo "=========================================="
echo "Host: $HOST"
echo "Port: $PORT"
echo "Web Renderer: $WEB_RENDERER"
echo "Debug Mode: $DEBUG_MODE"
echo ""

# Check if port is already in use
if lsof -Pi :$PORT -sTCP:LISTEN -t >/dev/null 2>&1 ; then
  echo "Warning: Port $PORT is already in use"
  echo "Attempting to find available port..."
  PORT=$((PORT + 1))
  while lsof -Pi :$PORT -sTCP:LISTEN -t >/dev/null 2>&1; do
    PORT=$((PORT + 1))
  done
  echo "Using port: $PORT"
fi

# Build run command
RUN_CMD="flutter run -d chrome --web-port=$PORT"

if [ "$WEB_RENDERER" != "auto" ]; then
  RUN_CMD="$RUN_CMD --web-renderer=$WEB_RENDERER"
fi

if [ "$DEBUG_MODE" = "true" ]; then
  RUN_CMD="$RUN_CMD --debug"
fi

echo "Running: $RUN_CMD"
echo ""
echo "Press 'r' to hot reload"
echo "Press 'R' to hot restart"
echo "Press 'q' to quit"
echo ""

eval $RUN_CMD
`,
    output: {
      path: "scripts",
      filename: "dev",
      extension: ".sh",
    },
  },

  // ---------------------------------------------------------------------------
  // Dockerfile
  // ---------------------------------------------------------------------------
  {
    id: "dockerfile",
    name: "Dockerfile",
    description: "Dockerfile for containerized builds",
    type: "file",
    source: `# Dockerfile for Flutter PWA
# Generated by Offline Flutter PWA Builder

# Build stage
FROM ghcr.io/cirruslabs/flutter:{{flutterVersion}} AS build

WORKDIR /app

# Copy pubspec files
COPY pubspec.yaml pubspec.lock ./

# Get dependencies
RUN flutter pub get

# Copy source code
COPY . .

# Build web app
RUN flutter build web --release --tree-shake-icons

# Production stage - nginx
FROM nginx:alpine

# Copy build output
COPY --from=build /app/build/web /usr/share/nginx/html

# Copy nginx configuration
COPY nginx.conf /etc/nginx/conf.d/default.conf

# Expose port
EXPOSE 80

# Start nginx
CMD ["nginx", "-g", "daemon off;"]
`,
    output: {
      path: "",
      filename: "Dockerfile",
      extension: "",
    },
  },

  // ---------------------------------------------------------------------------
  // Nginx Configuration
  // ---------------------------------------------------------------------------
  {
    id: "nginx_config",
    name: "Nginx Configuration",
    description: "Nginx configuration for serving Flutter PWA",
    type: "file",
    source: `# Nginx Configuration for Flutter PWA
# Generated by Offline Flutter PWA Builder

server {
    listen 80;
    server_name localhost;
    root /usr/share/nginx/html;
    index index.html;

    # Security headers
    add_header X-Content-Type-Options nosniff;
    add_header X-Frame-Options SAMEORIGIN;
    add_header X-XSS-Protection "1; mode=block";
    add_header Referrer-Policy strict-origin-when-cross-origin;

    # Enable gzip compression
    gzip on;
    gzip_types text/plain text/css application/json application/javascript text/xml application/xml application/wasm;
    gzip_min_length 1000;

    # Service worker
    location /flutter_service_worker.js {
        add_header Cache-Control "no-cache";
        add_header Service-Worker-Allowed "/";
    }

    # Static assets (long cache)
    location /assets/ {
        add_header Cache-Control "public, max-age=31536000, immutable";
    }

    # WASM files
    location ~* \\.wasm$ {
        add_header Content-Type application/wasm;
        add_header Cache-Control "public, max-age=31536000, immutable";
    }

    # JavaScript and CSS
    location ~* \\.(js|css)$ {
        add_header Cache-Control "public, max-age=31536000, immutable";
    }

    # SPA fallback
    location / {
        try_files $uri $uri/ /index.html;
    }

    # Error pages
    error_page 500 502 503 504 /50x.html;
    location = /50x.html {
        root /usr/share/nginx/html;
    }
}
`,
    output: {
      path: "",
      filename: "nginx",
      extension: ".conf",
    },
  },

  // ---------------------------------------------------------------------------
  // Build Barrel File
  // ---------------------------------------------------------------------------
  {
    id: "build_barrel",
    name: "Build Barrel File",
    description: "Export file for build configuration",
    type: "file",
    source: `// Build Configuration
// Generated by Offline Flutter PWA Builder

export 'environment.dart';
`,
    output: {
      path: "lib/core/config",
      filename: "config",
      extension: ".dart",
    },
  },
];

export default BUILD_TEMPLATES;
